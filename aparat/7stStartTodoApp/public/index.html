<!DOCTYPE html>
<html>
    <head>
        <title>firs app</title>
        <link rel="stylesheet" href="libs/bootstrap/css/bootstrap.min.css">

    </head>
    <body>
        <div class="container">
            <header>
                <h1>This is Node.js TODO app</h1>
                <p>you can manage your daily tasks by this app</p>
            </header>
            <!-- create form -->
            <div class="row">
                <div class="col">
                    <!-- return false baraye inke be soorate single page kard konad-->
                    <form v-on:submit.prevent="submitForm" autocomplete="off" id="form">
                        <div class="form-group">
                            <label for="newTodo">{{editMode ? 'Update Todo' : 'Add Todo'}}</label>
                            <input type="text" class="form-control" id="new-todo" v-model="newTodo.text" placeholder="what you are going to do?"></input>
                        </div>
                        <button class="btn btn-succes">{{editMode ? 'Save' : 'Add'}}</button>
                    </form>
                </div>
            </div>
            <!-- data table -->
            <div class="row mt-5">
                <div class="col">
                    <table class="table table-striped" id="todo-table">
                        <tbody>
                          <tr v-for="todo in todos"> 
                            <td>{{todo.text}}</td>
                            <td with="10"><a v-on:click="beginUpdating(todo)" class="btn text-warning btn-sm">Edit</a></td>
                            <td with="10"><a v-on:click="deleteTodo(todo)" class="btn text-danger btn-sm">Delete</a></td>
                          </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- scripts -->
        <script src="libs/jQuery/jquery-3.3.1.min.js"></script>
        <script src="libs/bootstrap/js/bootstrap.min.js"></script>
        <script src="libs/vue/vue.min.js"></script>

        <script>
            var model = new Vue({
                el:'#todo-table',
                data: {
                    todos: [{text: 'todo one'}]
                },
                methods: {
                    beginUpdating: function(todo) {
                        form.editMode = true;
                        form.oldTodo = todo;
                        form.newTodo = todo;
                    }
                }
            });

            var form = new Vue({
                el: '#form',
                data: {
                    editMode: false,
                    oldTodo: undefined,
                    newTodo: {text: ''}
                },
                methods: {
                    submitForm: function() {
                        if(this.editMode) {
                            updateTodo(this.newTodo)
                        } else {
                            createTodo();
                        }
                    }
                }
            })

            function createTodo() {
                var newTodo = $('#new-todo').val();
                // validation.

                if(!newTodo){
                    alert('you should enter a text a new todo');
                    return;
                }
                // add new todo to to todo list
                $.post('/todos', {text: newTodo}, function(data){

                    getTodos();
                }).fail(function(err) {
                    console.log(err);
                    alert('operation failed');
                })

                // clear new todo text box
                $('#new-todo').val('');
                
            }

            // get todos
            function getTodos() {
                $.get('/todos' , function(data) {
                    model.todos = data;
                })
            }
            getTodos();

            // delete todo
            function deleteTodo(todo) {
                // jQuery don't have method delete, we use ajax
                $.ajax({
                    url: '/todos',
                    contentType: 'application/json',
                    data: JSON.stringify(todo),
                    method: 'delete'
                }).done(function() {
                    getTodos();
                }).fail(function(err) {
                    console.log(err);
                    alert('opration failed.')
                })
            }

            // update todo

            function updateTodo(newTodo) {
                    // jQuery don't have method delete, we use ajax
                    $.ajax({
                    url: '/todos',
                    contentType: 'application/json',
                    data: JSON.stringify(newTodo),
                    method: 'put'
                }).done(function() {
                    // for change state to add
                    form.editMode = false;
                    form.newTodo = {text: ''};
                    getTodos();
                }).fail(function(err) {
                    console.log(err);
                    alert('opration failed.')
                })
            }

            // updateTodo({text: 'javid'}, {text: 'update todo'});
        </script>
    </body>
</html>